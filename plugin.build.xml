<project name="plugin" default="build.update.jar">
  <description>
  Provides the target for building a plugin jar file of the Eclipse sensor.
  </description>

  <import file="build.xml" />

  <property name="p2.build.repo" value="file:${buildDirectory}/buildRepo" />
  <property name="bundleId" value="org.hackystat.sensor.eclipse" />
  <property name="bundleVersion" value="8.0.1123" />
  <property name="p2.publishonerror" value="false" />

  <!-- Compiler settings. -->
  <property name="javacFailOnError" value="true" />
  <property name="javacDebugInfo" value="on" />
  <property name="javacVerbose" value="false" />
  <property name="logExtension" value=".log" />
  <property name="compilerArg" value="" />
  <property name="javacSource" value="1.6" />
  <property name="javacTarget" value="1.6" />

  <condition property="bundleBootClasspath" value="${JavaSE-1.6}">
    <isset property="JavaSE-1.6" />
  </condition>
  <condition property="bundleJavacSource" value="1.6">
    <isset property="JavaSE-1.6" />
  </condition>
  <condition property="bundleJavacTarget" value="1.6">
    <isset property="JavaSE-1.6" />
  </condition>
  <property name="bundleJavacSource" value="${javacSource}" />
  <property name="bundleJavacTarget" value="${javacTarget}" />
  <property name="bundleBootClasspath" value="${bootclasspath}" />

  <target name="init" depends="properties">
    <property name="build.result.folder" value="${build.dir}" />
    <property name="temp.folder" value="${build.dir}" />
    <property name="plugin.destination" value="${basedir}" />
    <condition property="p2.publish.parts" value="true">
      <istrue value="${p2.gathering}" />
    </condition>
    <property name="compilation.problem.marker" value="${build.result.folder}/compilation.problem" />
    <condition property="compilation.problem.marker.exists" value="true">
      <and>
        <available file="${compilation.problem.marker}" />
        <isfalse value="p2.publishonerror" />
      </and>
    </condition>
  </target>

  <target name="properties" if="eclipse.running">
    <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter" />
  </target>

  <target name="build.update.jar" depends="init" description="Build the plug-in: org.hackystat.sensor.eclipse for an update site.">
    <delete dir="${temp.folder}" />
    <mkdir dir="${temp.folder}" />
    <antcall target="build.jars" />
    <antcall target="gather.bin.parts">
      <param name="destination.temp.folder" value="${temp.folder}/" />
    </antcall>
    <jar destfile="${plugin.destination}/org.hackystat.sensor.eclipse_8.0.1123.jar" basedir="${temp.folder}/org.hackystat.sensor.eclipse_8.0.1123" filesetmanifest="merge" />
    <delete dir="${temp.folder}" />
  </target>

  <target name="build.jars" depends="init" description="Compile classes and build nested jars for the plug-in: org.hackystat.sensor.eclipse.">
    <delete file="${compilation.problem.marker}" quiet="true" />
    <available property="sensor.eclipse.jar" file="${build.result.folder}/sensor.eclipse.jar" />
    <antcall target="sensor.eclipse.jar" />
  </target>

  <target name="sensor.eclipse.jar" depends="init" unless="sensor.eclipse.jar" description="Create jar: org.hackystat.sensor.eclipse sensor.eclipse.jar.">
    <delete dir="${temp.folder}/sensor.eclipse.jar.bin" />
    <mkdir dir="${temp.folder}/sensor.eclipse.jar.bin" />
    <path id="sensor.eclipse.jar.classpath">
      <fileset dir="${env.ECLIPSE_HOME}/plugins" includes="*.jar" />
      <pathelement path="${lib.dir}/sensorshell.jar" />
      <pathelement path="${lib.dir}/activation.jar" />
      <pathelement path="${lib.dir}/jaxb-api.jar" />
      <pathelement path="${lib.dir}/jaxb-impl.jar" />
      <pathelement path="${lib.dir}/jsr173_1.0_api.jar" />
      <fileset file="${env.JUNIT_HOME}/junit-${junit.version}.jar" />
    </path>

    <!-- compile the source code -->
    <javac destdir="${temp.folder}/sensor.eclipse.jar.bin" failonerror="${javacFailOnError}" verbose="${javacVerbose}" debug="${javacDebugInfo}" 
      					includeAntRuntime="no" bootclasspath="${bundleBootClasspath}" source="${bundleJavacSource}" target="${bundleJavacTarget}">
      <compilerarg line="${compilerArg}" compiler="${build.compiler}" />
      <classpath refid="sensor.eclipse.jar.classpath" />
      <src path="${src.dir}" />
      <compilerarg line="-log '${temp.folder}/sensor.eclipse.jar.bin${logExtension}'" compiler="org.eclipse.jdt.core.JDTCompilerAdapter" />
    </javac>
    <antcall target="checkCompilationResults" />
    <!-- Copy necessary resources -->
    <copy todir="${temp.folder}/sensor.eclipse.jar.bin" failonerror="true" overwrite="false">
      <fileset dir="${src.dir}">
        <exclude name="**/*.java" />
        <exclude name="**/package.htm*" />
      </fileset>
    </copy>
    <mkdir dir="${build.result.folder}" />
    <jar destfile="${build.result.folder}/sensor.eclipse.jar" basedir="${temp.folder}/sensor.eclipse.jar.bin" />
    <delete dir="${temp.folder}/sensor.eclipse.jar.bin" />
  </target>

  <target name="checkCompilationResults" if="compilation.error.occured">
    <echo file="${compilation.problem.marker}" message="org.hackystat.sensor.eclipse : compilation.error.occured=${compilation.error.occured}" />
  </target>

  <target name="gather.bin.parts" depends="init" if="destination.temp.folder">
    <mkdir dir="${destination.temp.folder}/org.hackystat.sensor.eclipse_8.0.1123" />
    <copy todir="${destination.temp.folder}/org.hackystat.sensor.eclipse_8.0.1123" failonerror="true" overwrite="false">
      <fileset dir="${build.result.folder}">
        <include name="sensor.eclipse.jar" />
      </fileset>
    </copy>
    <copy todir="${destination.temp.folder}/org.hackystat.sensor.eclipse_8.0.1123" failonerror="true" overwrite="true">
      <fileset dir="${basedir}/plugin">
        <include name="META-INF/" />
        <include name="plugin.xml" />
        <include name="sensor.eclipse.jar" />
        <include name="lib/sensorshell.jar" />
        <include name="lib/activation.jar" />
        <include name="lib/jaxb-api.jar" />
        <include name="lib/jaxb-impl.jar" />
        <include name="lib/jsr173_1.0_api.jar" />
      </fileset>
    </copy>
    <antcall target="apitools.generation">
      <param name="target.folder" value="${destination.temp.folder}/org.hackystat.sensor.eclipse_8.0.1123" />
      <param name="projectLocation" value="${basedir}" />
      <param name="projectName" value="${bundleId}_${bundleVersion}" />
      <param name="binary.folders" value="${destination.temp.folder}/org.hackystat.sensor.eclipse_8.0.1123/sensor.eclipse.jar:${lib.dir}/jsr173_1.0_api.jar:${lib.dir}/sensorshell.jar:${lib.dir}jaxb-api.jar:${lib.dir}/jaxb-impl.jar:${lib.dir}/activation.jar" />
    </antcall>
  </target>

  <target name="clean" depends="init" description="Clean the plug-in: org.hackystat.sensor.eclipse of all the jars and logs created.">
    <delete file="${build.result.folder}/sensor.eclipse.jar" />
    <delete file="${plugin.destination}/org.hackystat.sensor.eclipse_8.0.1123.jar" />
    <delete dir="${temp.folder}" />
    <delete file="${compilation.problem.marker}" quiet="true" />
  </target>

  <target name="apitools.generation" if="generateAPIDescription">
    <apitooling.apigeneration projectName="${projectName}" project="${projectLocation}" binary="${binary.folders}" target="${target.folder}" />
  </target>
</project>
